<!DOCTYPE html>
<html>
  <head>
    <title>Cowsay</title>
    <style>
      /* Custom CSS for StackBlitz */
      body {
        margin: 0;
        overflow: hidden;
      }

      html {
        filter: invert(100%);
      }

      #cow-speech {
        font-family: monospace;
        font-size: 14px;
        white-space: pre;
        margin: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100vw;
        height: 100vh;
        text-align: center;
        line-height: 1.4;
      }

      #cow-speech pre {
        margin: 0;
      }

      #cow-speech .cow {
        margin-bottom: 10px;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <div id="cow-speech"></div>

    <script>
      function loadScript(url, callback) {
        var script = document.createElement('script');
        script.src = url;
        script.onload = callback;
        script.onerror = function () {
          throw new Error(`Failed to load script: ${url}`);
        };
        document.head.appendChild(script);
      }

      function loadPackages(packages, callback) {
        var count = packages.length;
        function packageLoaded() {
          count--;
          if (count === 0) {
            callback();
          }
        }

        function loadNextPackage(index) {
          var packageName = packages[index];
          var urls = [
            `https://unpkg.com/${packageName}/dist/${packageName}.min.js`,
            `https://unpkg.com/${packageName}/build/${packageName}.min.js`,
            `https://unpkg.com/${packageName}/umd/${packageName}.min.js`,
            `https://unpkg.com/${packageName}/${packageName}.min.js`,
            `https://unpkg.com/${packageName}/dist/${packageName}.min.mjs`,
            `https://unpkg.com/${packageName}/build/${packageName}.min.mjs`,
            `https://unpkg.com/${packageName}/umd/${packageName}.min.mjs`,
            `https://unpkg.com/${packageName}/${packageName}.min.mjs`,
            `https://unpkg.com/${packageName}/build/${packageName}.umd.js`,
          ];

          function tryNextURL(urlIndex) {
            if (urlIndex >= urls.length) {
              if (index < packages.length - 1) {
                loadNextPackage(index + 1);
              } else {
                throw new Error(`Failed to load ${packageName} package.`);
              }
            } else {
              var url = urls[urlIndex];
              loadScript(url, function () {
                packageLoaded();
                callback();
              });
            }
          }

          tryNextURL(0);
        }

        loadNextPackage(0);
      }

      var packages = ['axios', 'cowsay', 'canvas-confetti'];
      loadPackages(packages, function () {
        try {
          var text = '';
          var speech = '';

          // Check if required variables/functions are exported by the package
          for (var i = 0; i < packages.length; i++) {
            if (typeof window[packages[i]] === 'undefined') {
              throw new Error(`Failed to load ${packages[i]} package.`);
            }
          }

          axios
            .get('https://jsonplaceholder.typicode.com/todos/1')
            .then(function (response) {
              text = response.data.title;

              // Check if the required function exists in the cowsay package
              if (typeof cowsay.say !== 'function') {
                throw new Error('Invalid cowsay package.');
              }

              // Generate cowsay speech
              speech = cowsay.say({
                text: text,
              });

              // Replace default eye and tongue characters
              speech = speech.replace('oo', 'oO').replace('(__)', '(O)');

              document.getElementById('cow-speech').innerHTML = `<pre>${speech}</pre>`;
              confetti();
            })
            .catch(function (error) {
              text = error;

              // Check if the required function exists in the cowsay package
              if (typeof cowsay.say !== 'function') {
                throw new Error('Invalid cowsay package.');
              }

              // Generate cowsay speech
              speech = cowsay.say({
                text: text,
              });

              // Replace default eye and tongue characters
              speech = speech.replace(/<\$\$>/g, 'oO').replace(/<\\>/g, 'U ');

              document.getElementById('cow-speech').innerHTML = `<pre>${speech}</pre>`;
            });
        } catch (e) {
          console.error(e);
          document.getElementById('cow-speech').innerHTML = e;
        }
      });
    </script>
  </body>
</html>
